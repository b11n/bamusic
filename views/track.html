<html>
<head>
	<title> <%= details.items[0].snippet.title %> </title>
	  <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=0">


	<meta property="og:site_name" id="metaTitle" content="BaMusic">
	<meta property="og:title" id="metaTrack" content="<%= details.items[0].snippet.title %>" />
	<meta property="og:description" content="Listen to songs for free" />
	<meta property="og:image" id="metaImage" itemprop="image" content="<%= details.items[0].snippet.thumbnails.medium.url %>">
	<meta property="og:type" content="website" />
	<meta property="og:updated_time" content="1440432933" />

	  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
	  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">



	<style type="text/css">

	body{
		    background: #EFEFEF;
		    font-family: sans-serif;
		    margin:0px;
	}
	.fl{
		float: left;
	}

	.thumb{
		width: 80px;
		height: 80px;
		    background-image: url("https://static.pexels.com/photos/30222/pexels-photo-30222.jpg");
    background-size: cover;
        margin-left: 10px;
    margin-top: 10px;
	}
	.title-block{
		    margin-top: 45px;
	}

	.title-holder{
		    margin-top: 30px;
    margin-left: 15px;
    max-width: 65%;
	}

	.maincard{background: white;
    overflow: hidden;
    width: 100%;
    padding: 10px;
    box-sizing: border-box;
        position: relative;
    height: 200px;
        border-radius: 0px;
    box-shadow: 1px 1px 5px #B1B1B1;
}

.oh{
	overflow: hidden;
}

.seek{

    position: absolute;
    width: 100%;
    bottom: 0px;
}

.controls{
	text-align: center;
	font-size: 3em;
	position: relative;
	left:-10px;
	    color: white;
    margin: 7px;
}
.fa-play-circle,.fa-pause-circle{
	font-size: 1.5em;
}


#channel{
	    font-size: 1.5em;
    color: white;
    font-weight: bold;
        text-shadow: 1px 1px 3px #5F5F5F;
            white-space: nowrap;
    /* width: 12em; */
    overflow: hidden;
    text-overflow: ellipsis;
}
#title{
	white-space: nowrap;
    /* width: 12em; */
    overflow: hidden;
    text-overflow: ellipsis;
        font-size: 1em;
    color: white;
    font-weight: bold;
        text-shadow: 1px 1px 3px #5F5F5F;
}

.backdrop{
	width: 100%;
    height: 100%;
    position: absolute;
    left: 0px;
    top: 0px;
    background-image: url(https://static.pexels.com/photos/30222/pexels-photo-30222.jpg);
    background-size: cover;
    /* background-size: 535px; */
    -webkit-filter: blur(15px);
    background-size: cover;
    opacity: 0.9;
    /*-webkit-transition:1s all linear;*/
}

.related .backdrop{
	background:white;
	-webkit-filter: blur(0px);
}

#frontdrop{
	z-index: 1;
    position: absolute;
    width: 100%;
    left: 0px;
        height: 200px;
        top: 0;
}

#hiddenPlayer{
	/*display: none;*/
	width: 100%;
}

#seeker{
    position: absolute;
    height: 10px;
    width: 10px;
    background: red;
    border-radius: 50%;
    top: -3px;
}

.relatedcard{
	height: 66px;
    padding: 0px;
    margin-bottom: .4em;
    box-shadow: 0 2px 5px 0 rgba(0, 0, 0, 0.1), 0 2px 10px 0 rgba(0, 0, 0, 0.1);
}

.relatedcard .title-holder{
	margin-top: 15px;
}

.relatedcard  .thumb{
    width: 50px;
    height: 50px;

}

.related{
	    list-style: none;
	    padding: 5px 10px;
}

.related .title-block{
	margin-top: 0px;
}

.related .backdrop{
	opacity: 0.3;
}
#relatedTrackTitle{
    margin-top: 20px;
    font-size: 0.9em;
    letter-spacing: 0.05em;
    font-weight: bold;
    margin-bottom: 6px;
    text-transform: uppercase;
    color: #868080;
    margin-left: 10px;

}

.visualizer{
	position: absolute;
	left: 0;
	bottom: 0;
}

.related{
	position: relative;
	overflow: hidden;
}

.related li{
	position: relative;
	-webkit-transform:translateX(110%);
}

.related #channel{
	    color: #555;
    text-shadow: none;
    font-size: 1.2em;
    font-weight: bold;
    /* text-shadow: 1px 1px 3px #5F5F5F; */
    white-space: nowrap;
    /* width: 12em; */
    overflow: hidden;
    text-overflow: ellipsis;

}

.related #title{
	text-shadow: none;
    color: #777;
    font-size: 0.85em;
    font-weight: normal;
}



@-webkit-keyframes moving-gradient {
    0% { background-position: left bottom; }
    100% { background-position: right bottom; }
}

.bar {
    width: 100%;
   height: 8px;
    
    background: -webkit-linear-gradient( left, #31A2DA 15%, #42C0FF 50%, #44BEFF 85%, #31A2DA 100% ) repeat;
    
    -webkit-background-size: 50% 100%;
    -webkit-animation-name: moving-gradient;
    -webkit-animation-duration: 1s;
    -webkit-animation-iteration-count: infinite;
    -webkit-animation-timing-function: linear;
}

.half { width: 50p%; overflow-x: hidden; }
.half.full {     
	width: 100%;
    position: absolute;
    top:0;
    opacity: 0.8; }
.half .bar { width: 200%; }
.half.full .bar { -webkit-animation-duration: 1s; }

.header-icon-container{
    margin-right: 15px;
    margin-top: 5px;
}


.header-icon{
    float: right;
    margin: 6px;
    font-size: 1.5em;
    color: white;
}

	</style>
</head>
<body>

	<div class="maincard">
		<div class="backdrop"></div>
		<div class="visualizer"></div>

		<div id="frontdrop">
		<div class="header-icon-container">
			
			<i class="fa fa-heart-o header-icon" id="collection" aria-hidden="true" ></i>
		</div>
		<div class="title-block">
			<div class="oh">
				<div class="thumb fl">
					
				</div>
				<div class="title-holder fl">

					<div id="channel">Artist </div>
					<div id="title">Song Name </div>

				</div>
			</div>
			
		</div>
		<div class="seek">
			<audio id="hiddenPlayer" controls  type="audio/mpeg"></audio>
			<!-- <div id="seeker"></div> -->
		</div>


<div class="half full">
    <div class="bar"></div>
</div>



		
		</div>
	</div>


<div id="relatedTrackTitle">Related Tracks</div>
	<div class="related">




	</div>





	<script type="text/template" id="relatedCardItem">
	<li>
	

		<div class="maincard relatedcard">
		<div class="backdrop"></div>

		<div id="frontdrop">

		<div class="title-block">
			<div class="oh">
				<div class="thumb fl">
					
				</div>
				<div class="title-holder fl">

					<div id="channel">Artist </div>
					<div id="title">Song Name </div>

				</div>
			</div>
			
		</div>

		
		</div>
	</div>
	
	</li>
	</script>


	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

	    <script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <script src="/eq.js"></script>

	<script type="text/javascript">

	function fetchDetails(idParam){


		


		var id = idParam || window.location.pathname.split("/")[window.location.pathname.split("/").length-1];
		$("#collection").removeClass("fa-heart").addClass("fa-heart-o");
		checkTrackInUserCollection(id);
		player.setSource(id);
		player.play(id);
		$.ajax({
			url:"/api/video/"+id,
			success:function(data){
				var data = JSON.parse(data);
				console.log(data);

				addToCollectionListener(data);

			
					fetchRelated(id);
			

				
				$("title").html(data.items[0].snippet.title);
				$("#metaTitle").attr("content",data.items[0].snippet.title);
				$("#metaImage").attr("content",data.items[0].snippet.thumbnails.medium.url);
				$("#channel").html(data.items[0].snippet.channelTitle)
				$("#title").html(data.items[0].snippet.title);
				$(".thumb")[0].style.backgroundImage = "url("+data.items[0].snippet.thumbnails.medium.url+")";
				$(".maincard .backdrop")[0].style.backgroundImage = "url("+data.items[0].snippet.thumbnails.medium.url+")";

				
			}
		})
	}

	function checkTrackInUserCollection(id){
		$.ajax({
			url:"/api/checkTrackInUserCollection/"+id,
			success:function(data){
				if(data.success){
					$("#collection").removeClass("fa-heart-o").addClass("fa-heart");
				}
			}
		})
	}

	function addToCollectionListener(data){
		$("#collection").off('click');

		$("#collection").on('click',function(e){
			$.ajax({
				"url":"/api/collection",
				data:{
					"name":data.items[0].snippet.title,
					"videoid":data.items[0].id,
					"thumb":data.items[0].snippet.thumbnails.standard.url
				},
				type:"POST",
				success:function(data){
					$("#collection").removeClass("fa-heart-o").addClass("fa-heart");
				}
			})
		});

	}


	var Player = function(){
		this.player = $("#hiddenPlayer")[0];
		this.id = "";


		this.state = false;

		var _this= this;


		this.player.onerror = function(e){
			showLoader();
			initilizeDownload(_this.id,function(){
				_this.player.setAttribute("src","/download/"+_this.id+".mp3");
				 hideLoader();
				_this.play();

			});
			

		}

		this.player.onplay = function(){
			hideLoader();
		}



		this.play = function(){
			 hideLoader();
			this.player.play();

		}


		this.pause = function(){
			this.player.pause();
		}

		this.setSource = function(id){
			this.player.setAttribute("src","/download/"+id+".mp3");
			this.id = id;
		}

	}

	var player = new Player();

	fetchDetails();


	function showLoader(){
		$(".half.half").show()
	}

	function hideLoader(){
		$(".half.half").hide()
	}


	function fetchRelated(videoId){
		$(".related").html("");
		$.ajax({
			url:"/related/"+videoId,
			success:function(data){
					var data = JSON.parse(data);
					for (var i = 0; i < data.items.length; i++) {

						var name = data.items[i].snippet.title;
						var id = data.items[i].id.videoId;
						var template = $("#relatedCardItem").html();

						var $template = $(template);
						$(".related").append($template);
						
						$template.attr("id","track"+id)

						$template.find("#title").html(name.split("-")[0])
						$template.find("#channel").html(name.split("-")[1])
						$template.find(".thumb")[0].style.backgroundImage = "url(https://i.ytimg.com/vi/"+id+"/mqdefault.jpg)";

						$template.on("click",relatedItemClickListener);

						slideIn(0);
						
				};
			}
		})
	}

	function addToCollection(id,name,cb){
/*
		{"name":"Katy Perry - Dark Horse (Official) ft. Juicy J","videoid":"0KSOMA3QBU0","thumb":"https://i.ytimg.com/vi/0KSOMA3QBU0/default.jpg"}*/

	}

	function initilizeDownload(id,cb){

		$.ajax({
			url:"/api/initializeDownload/"+id,
			type:"POST",
			success:function(data){
				console.log(data);
				cb();
			}
		})

	}

	function relatedItemClickListener(e){
		var id = $(e.currentTarget).attr("id").split("track")[1];
		fetchDetails(id);
		showLoader();
		

	}


	function slideIn(i){
			if(i==10){
				return;
			}

			setTimeout(function(){
		  	 $($(".related li")[i]).addClass("animated bounceInRight")
		  	 window.requestAnimationFrame(function(){
		  	 	slideIn(i+1)
		  	 });
		  },i*10)

	}

	




	</script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73035652-1', 'auto');
  ga('send', 'pageview');

</script>


</body>
</html>
